# Nginx sample configuration for hosting in a subfolder with WebSocket support
# Assuming droidtv-remote is configured with base_url_path: "/remote/" in data/config.yaml
# and the server is running on port 7503.

    location ^~ /remote/ {
        # Strip /remote prefix before sending to backend
        rewrite ^/remote/(.*)$ /$1 break;

        proxy_pass http://localhost:7503;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        # Don't buffer responses
        proxy_buffering off;

        # 1. Force Nginx to support byte-range requests (essential for seeking)
        proxy_force_ranges on;

        # 2. Ensure the Range headers from the browser actually reach the backend
        proxy_set_header Range $http_range;
        proxy_set_header If-Range $http_if_range;
    }

    # Service worker must be served from same path with no-cache
    location = /remote/sw.js {
        rewrite ^/remote/(.*)$ /$1 break;

        proxy_pass http://localhost:7503;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Force no caching of service worker
        add_header Cache-Control "no-cache, no-store, must-revalidate" always;
        add_header Pragma "no-cache" always;
        add_header Expires "0" always;
        proxy_buffering off;
    }

    # HTML files with no-cache
    location ~ ^/remote/.*\.html$ {
        rewrite ^/remote/(.*)$ /$1 break;

        proxy_pass http://localhost:7503;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        add_header Cache-Control "no-cache, no-store, must-revalidate" always;
        add_header Pragma "no-cache" always;
        add_header Expires "0" always;
        proxy_buffering off;
    }
